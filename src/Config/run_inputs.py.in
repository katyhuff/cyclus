#!/usr/bin/python

import sys
import subprocess
from subprocess import Popen, PIPE, STDOUT
import os
import re
import argparse


def main():
    """This function finds input files, runs them, and prints a summary"""
    args = check_inputs()
    input_path = "@input_path@"
    cyclus_path =  "@cyclus_path@/cyclus"
    files, catalogs, catalognames = get_files(input_path,args)
    copy_catalogs(catalogs,cyclus_path.strip("cyclus"))
    summ = Summary()
    for name in files :
        file_to_test = TestFile(cyclus_path, name, args.verb) 
        file_to_test.run()
        summ.add_to_summary(file_to_test)
    clean_catalogs(cyclus_path.strip("cyclus"),catalognames)
    summ.print_summary()

def check_inputs():
    """This function checks the input arguments"""
    parser = argparse.ArgumentParser(description='This script finds and runs \
            input files')
    parser.add_argument('-filter',action="store", dest="directory", 
            default="", type=str, help="Filter which inputs to run by naming a \
            subdirectory")
    parser.add_argument('-v',action="store", dest="verb", default=0,type=int, 
            help="output log verbosity can be integer (0-11) or text \
            (LEV_ERROR, LEV_WARN, LEV_DEBUG1-LEV_DEBUG5")
    results = parser.parse_args()
    return results

def get_files(path, args):
    """This function walks the 'path' tree and finds input files"""
    catalogs=[]
    catalognames=[]
    inputs=[]
    for root, dirs, files in os.walk(path, followlinks=True):
        if '.git' in dirs:
            dirs.remove('.git')
        for directory in dirs :
            if re.search(args.directory, directory) : 
                for name in files: 
                    if re.search("\.xml",name) :
                        if re.search("recipebook",name) or \
                                re.search("facilitycatalog",name):
                            catalogs.append(os.path.join(root,name))
                            catalognames.append(name)
                        else : 
                            inputs.append(os.path.join(root, name))
                    else :
                        files.remove(name)
    print "The catalogs to be moved are:"
    print catalogs
    print "The files to be tested are:"
    print inputs
    return inputs, catalogs, catalognames

def copy_catalogs(catalogs,cyclus_path) :
    """Copies files in the catalogs list to the cyclus executable directory""" 
    for cat in catalogs : 
        p = Popen("cp "+cat+" "+cyclus_path,
                shell=True, stdout=PIPE, stderr=STDOUT)

def clean_catalogs(cyclus_path, catalogs) : 
    """Removes previously copied catalogs from executable directory."""
    for cat in catalogs :
        p = Popen("rm "+ os.path.join(cyclus_path,cat),
                shell=True, stdout=PIPE, stderr=STDOUT)

class Summary():
    """An object to hold the results of all the tests"""
    def __init__(self):
        self.passed = []
        self.failed = []

    def add_to_summary(self, test_file) :
        """Adds a test file to this summary object"""
        if test_file.passed : 
            self.passed.append( test_file.infile )
        else :
            self.failed.append( test_file.infile )

    def print_summary(self) :
        """Prints the summary"""
        print "Input files passed = " + str(len(self.passed))
        print "Input files failed = " + str(len(self.failed))
        print "Failed input files : " 
        for test in self.failed : 
            print test

class TestFile():
    """An object representing the inputxml file to test"""
    def __init__(self, cyclus_path, file_path, verb):
        self.infile = file_path 
        self.cyclus_path = cyclus_path 
        self.passed=True
        self.flag = " -v"+str(verb)+" "
  
    def run(self):
        """Runs all of the input file tests"""
        output = self.get_output()
        if self.no_errors(output) :
            self.passed = True
        else :
            self.passed = False

    def get_output(self):
        """Returns the output from running the FileTest"""
        try :
            p = Popen(self.cyclus_path+" "+ self.infile + self.flag,
                    shell=True, stdout=PIPE, stderr=STDOUT)
            io_tuple = p.communicate()
            output = io_tuple[0]
        except subprocess.CalledProcessError, e:
            print(e)
        return output
        
    def no_errors(self, output):
        """returns true if there were no errors or segfaults running this TestFile"""
        to_ret = True
        print "Input file " + self.infile 
        if re.search("No such file or directory",output) :
            print "Cyclus executable not found in path."
        elif re.search("ERROR",output) or re.search("Segmentation fault",output):
            to_ret = False
            print " resulted in errors: "
            print output
        else :
            print " passed. "
        return to_ret 

if __name__ == '__main__' : main()
